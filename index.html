<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Fork my world</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

    <script src='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css' rel='stylesheet' />

    <script src="/filedrop-min.js"></script>
    <script src="/pako.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .map-overlay {
            position: absolute;
            width: 25%;
            top: 0;
            left: 0;
            padding: 10px;
            background-color: transparent;
        }

        #zdir {
            border: 5px solid blue;
            width: 400px;
            height: 200px;
            background-color: grey;
        }
    </style>

</head>

<body>

    <div id='map'></div>
    <div class="map-overlay top">
        <div id="zdir">
            <h1>Fork my world</h1>
            <p>Drop a directory hereâ€¦</p>
            <p>Drag one or more files to this Drop Zone ...</p>
        </div>
    </div>



    <script>
        class Block {
            constructor () {

            }
        }
        const FILENAME_MASK1 = "olhwjsktri";
        const FILENAME_MASK2 = "eizxdwknmo";
        var FILENAME_ENCODING = {};
        for (var i = 0; i < FILENAME_MASK1.length; i++) {
            FILENAME_ENCODING[FILENAME_MASK1.charAt(i)] = i
        }
        const MAP_WIDTH = 512
        const TILE_WIDTH = 128
        const TILE_HEADER_LEN = TILE_WIDTH**2;
        const TILE_HEADER_SIZE = TILE_HEADER_LEN*2;
// BLOCK_BITMAP_SIZE = 512
// BLOCK_EXTRA_DATA = 3
// BLOCK_SIZE = BLOCK_BITMAP_SIZE + BLOCK_EXTRA_DATA
// BITMAP_WIDTH = 64

        class Tile {
            constructor(filename, data) {

                // TODO: try catch
                this.id = filename.slice(4,-2).split("").map(idMasked => FILENAME_ENCODING[idMasked]).join("");
                this.x = this.id % MAP_WIDTH;
                this.y = Math.round(this.id / MAP_WIDTH);
                // console.log()
                console.log(`Loading tile. id: ${this.id}, x: ${this.x}, y: ${this.y}`);

                // TODO: try catch
                this.data = pako.inflate(data);
                // console.log(this.data);
            }
        }
        class FogMap {
            constructor() {
            }
        }


        var fogMap = new FogMap();



        var zone = new FileDrop('zdir', { input: false });

        zone.event('upload', function (e) {
            while (cleared = zone.el.firstChild) {
                zone.el.removeChild(zone.el.firstChild);
            }

            var error = function () { alert('Problem reading the file system.'); }

            var done = function (files) {
                // files is standard FileDrop's FileList object.
                files.each(function (file) {
                    // file is FileDrop.File with native objects accessible
                    // as file.nativeFile and file.nativeEntry.
                    var node = document.createElement('p');
                    node.innerText = file.name

                    if (file.nativeFile) {
                        // This is a file. We can use any FileDrop method here
                        // like sendTo() and readData() - see below.
                        node.innerText += ' (' + file.size + ')';

                        file.readData(
                            function (data) {
                                var tile = new Tile(file.name, data)
                            },
                            function (e) { alert('Terrible error!') }
                        )
                        // var tile = new Tile(file.name, )

                    } else {
                        // This is a directory - it has no File API object.
                        node.innerHTML = '<b>' + node.innerHTML + '/</b>';
                    }

                    zone.el.appendChild(node);
                });

                // Let's show thumbs of images using FileDrop.File methods.
                files.images().each(function (file) {
                    file.readDataURI(function (uri) {
                        var img = new Image;
                        img.src = uri;
                        zone.el.appendChild(img);
                    });
                });
            };

            zone.eventFiles(e).each(function (root) {
                if (root.listEntries(done, error)) {
                    // Success.
                } else if (!root.nativeEntry) {
                    zone.el.innerHTML = '<p><b>File System API is not' +
                        ' supported by this browser.</b></p>';
                } else {
                    zone.el.innerHTML = '<p><b>Problem listing ' +
                        root.name + '.</b></p>';
                }
            });
        });







        mapboxgl.accessToken = 'pk.eyJ1IjoidGF2aW1vcmkiLCJhIjoiY2ozeHh3NXdjMDAwYTJ3bnk2ZXhqbTkzbiJ9.BGLmrBqqXkZv50HKrwaZRQ';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [114.20592531593752, 22.690129049232496],
            zoom: 10
        });


        // Add zoom and rotation controls to the map.
        map.addControl(new mapboxgl.NavigationControl());

        map.on('load', function () {

        });
    </script>
</body>

</html>