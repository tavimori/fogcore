<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fogcore Demo</title>
    <style>
        .slider-container {
            margin: 20px;
        }

        .map-container {
            margin-top: 30px;
        }

        #zdir {
            border: 5px solid;
            width: 100%;
            height: 100%;
            /* background-color: grey; */
        }
    </style>
    <script src="filedrop-min.js"></script>
</head>

<body>
    <h1>Fogcore Track Tilling Demo</h1>

    <div class="map-container">
        <img id="mapImage" alt="Map Image" src="" width="600">
    </div>

    <script type="module">
        import init, { FogMap, FogRenderer, lng_to_tile_x, lat_to_tile_y } from "../pkg/fogcore.js";
        
        async function loadFile(filename) {
            const response = await fetch(`tiles/${filename}`);
            const arrayBuffer = await response.arrayBuffer();
            return new Uint8Array(arrayBuffer);
        }

        async function initializeFogMap() {
            await init();
            let fogMap = new FogMap();
            
            // List of predefined files to load
            const files = [
                '2573lljsijod',    
                '33c1lljorhmz',
                '3fc9lorjsrwm',
                '5158lljorlmi',
                'cab3lotijkdk',
                // Add more files as needed
            ];

            for (const file of files) {
                try {
                    const data = await loadFile(file);
                    fogMap.add_fow_file(file, data);
                    console.log(`Loaded ${file}`);
                } catch (error) {
                    console.error(`Failed to load ${file}:`, error);
                }
            }

            // Initial render
            let render = new FogRenderer();
            let zoom = 8;
            let x = lng_to_tile_x(114.137, zoom);
            let y = lat_to_tile_y(22.678, zoom);

            let imageData = render.render_image(fogMap, x, y, zoom);
            renderImageOn(imageData, "mapImage");
        }

        initializeFogMap();
    </script>

    <script>
        window.renderImageOn = (imageData, imageId) => {
            console.log(`starting to render image for ${imageId}...`);
            const blob = new Blob([imageData], { type: 'image/png' });
            const url = URL.createObjectURL(blob);

            const imageDom = document.getElementById(imageId);
            console.log(`imageDom loaded.`);

            const oldUrl = imageDom.src;
            imageDom.src = url;

            console.log(`src replaced.`);

            if (oldUrl.startsWith('blob:')) {
                URL.revokeObjectURL(oldUrl);
            }
        }
    </script>
</body>

</html>